<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KASLIVE | Network Command</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="https://cryptologos.cc/logos/kaspa-kas-logo.png" type="image/png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
</head>
<body>
    
    <div id="canvas-container"></div>

    <div class="glass-overlay">
        <header>
            <div class="logo-area">
                <div class="live-indicator">
                    <span class="blink">●</span> LIVE
                </div>
                <h1>KASLIVE <span class="version">OS v2.0</span></h1>
            </div>
            <nav>
                <a href="#market">MARKET</a>
                <a href="#network">DAG</a>
                <a href="#l2">KRC-20</a>
                <a href="#whales">SONAR</a>
            </nav>
        </header>

        <main class="grid-container">
            
            <section class="panel hero-panel" id="market">
                <div class="panel-header">
                    <h3>MARKET OVERVIEW</h3>
                    <div class="price-ticker" id="kas-price">LOADING...</div>
                </div>
                <div id="tradingview_chart" class="tv-container"></div>
                <div class="market-sub-stats">
                    <div class="stat-mini">
                        <span class="label">VOL (24H)</span>
                        <span class="value" id="kas-volume">--</span>
                    </div>
                    <div class="stat-mini">
                        <span class="label">CAP</span>
                        <span class="value" id="kas-mcap">--</span>
                    </div>
                    <div class="stat-mini">
                        <span class="label">RANK</span>
                        <span class="value" id="kas-rank">--</span>
                    </div>
                </div>
            </section>

            <section class="panel hud-panel" id="network">
                <div class="panel-header"><h3>NETWORK METRICS</h3></div>
                <div class="hud-grid">
                    <div class="hud-item">
                        <div class="hud-circle" id="bps-circle">
                            <span class="hud-val" id="real-time-bps">--</span>
                            <span class="hud-label">BPS</span>
                        </div>
                    </div>
                    <div class="hud-item">
                        <span class="hud-label">HASHRATE</span>
                        <span class="hud-val large" id="hashrate">--</span>
                    </div>
                    <div class="hud-item">
                        <span class="hud-label">SUPPLY</span>
                        <span class="hud-val" id="current-supply">--</span>
                    </div>
                    <div class="hud-item">
                        <span class="hud-label">NEXT DROP</span>
                        <span class="hud-val warn" id="next-reduction-days">--</span>
                        <span class="hud-sub">DAYS</span>
                    </div>
                </div>
            </section>

            <section class="panel list-panel" id="l2">
                <div class="panel-header">
                    <h3>KRC-20 TERMINAL</h3>
                    <span class="status-badge">ONLINE</span>
                </div>
                <div class="terminal-window">
                    <table id="l2-table">
                        <thead>
                            <tr>
                                <th>ASSET</th>
                                <th>TVL</th>
                                <th>VOL 24H</th>
                                <th>CHG</th>
                                <th>ACTION</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </section>

            <section class="panel sonar-panel" id="whales">
                <div class="panel-header"><h3>WHALE SONAR (TOP 50)</h3></div>
                <div id="sonar-visualizer">
                    </div>
                <div class="whale-list-mini">
                    <table id="whale-table">
                        </table>
                </div>
            </section>

        </main>
        
        <footer>
            SYSTEM STATUS: OPERATIONAL • <a href="https://github.com/dnilgis/kaspai" target="_blank">SOURCE CODE</a>
        </footer>
    </div>

    <script>
        // --- 1. INITIALIZE TRADINGVIEW WIDGET ---
        new TradingView.widget({
            "width": "100%",
            "height": "100%",
            "symbol": "MEXC:KASUSDT",
            "interval": "60",
            "timezone": "Etc/UTC",
            "theme": "dark",
            "style": "1",
            "locale": "en",
            "toolbar_bg": "#f1f3f6",
            "enable_publishing": false,
            "allow_symbol_change": false,
            "container_id": "tradingview_chart",
            "hide_side_toolbar": true
        });

        // --- 2. THREE.JS BLOCKDAG VISUALIZER (The "Gimmick") ---
        const init3D = () => {
            const container = document.getElementById('canvas-container');
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer({ alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            container.appendChild(renderer.domElement);

            // Particles (Representing Blocks)
            const geometry = new THREE.BufferGeometry();
            const particlesCount = 300;
            const posArray = new Float32Array(particlesCount * 3);
            
            for(let i = 0; i < particlesCount * 3; i++) {
                posArray[i] = (Math.random() - 0.5) * 15;
            }
            geometry.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
            const material = new THREE.PointsMaterial({
                size: 0.05,
                color: 0x00CCCC, // Kaspa Cyan
                transparent: true,
                opacity: 0.8
            });
            const particles = new THREE.Points(geometry, material);
            scene.add(particles);

            camera.position.z = 5;

            // Animation Loop
            const animate = () => {
                requestAnimationFrame(animate);
                particles.rotation.y += 0.002;
                particles.rotation.x += 0.001;
                renderer.render(scene, camera);
            };
            animate();

            // Handle Resize
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        };
        init3D();

        // --- 3. DATA FETCHING LOGIC (Same as before, adapted for new UI) ---
        const formatNumber = (num, currency = true) => {
            if (typeof num === 'string') return num; 
            if (num >= 1000000000) return (num / 1000000000).toFixed(2) + 'B';
            if (num >= 1000000) return (num / 1000000).toFixed(2) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return currency ? '$' + num.toFixed(2) : num.toFixed(2);
        };

        const loadData = async (fileName) => {
            try {
                const response = await fetch(`data/${fileName}?t=${new Date().getTime()}`);
                return await response.json();
            } catch (e) { return {}; }
        };

        const updateDashboard = async () => {
            const market = await loadData('market_data.json');
            const net = await loadData('network_data.json');
            const l2 = await loadData('l2_data.json');
            const whales = await loadData('whale_data.json');

            // Market
            if (market.price_usd) {
                document.getElementById('kas-price').innerHTML = `$${market.price_usd} <span style="font-size:0.5em; color:${market.price_change_24h >= 0 ? '#0f0' : '#f00'}">${market.price_change_24h}%</span>`;
                document.getElementById('kas-volume').textContent = formatNumber(market.volume_24h);
                document.getElementById('kas-mcap').textContent = formatNumber(market.market_cap);
                document.getElementById('kas-rank').textContent = `#${market.ranking}`;
            }

            // Network
            if (net.hashrate) {
                document.getElementById('real-time-bps').textContent = net.real_time_bps;
                document.getElementById('hashrate').textContent = net.hashrate;
                document.getElementById('current-supply').textContent = net.current_supply;
                document.getElementById('next-reduction-days').textContent = net.next_reduction_days;
            }

            // KRC-20 Table
            if (l2.projects) {
                const tbody = document.querySelector('#l2-table tbody');
                tbody.innerHTML = '';
                l2.projects.forEach(p => {
                    const row = `<tr>
                        <td><span class="token-symbol">${p.symbol}</span></td>
                        <td>${formatNumber(p.tvl)}</td>
                        <td>${formatNumber(p.volume_24h)}</td>
                        <td style="color:${p.change_24h >= 0 ? '#00ffaa' : '#ff3366'}">${p.change_24h}%</td>
                        <td><a href="${p.visit}" target="_blank" class="btn-scan">SCAN</a></td>
                    </tr>`;
                    tbody.innerHTML += row;
                });
            }

            // Whale Sonar (Bubbles)
            if (whales.whales) {
                const sonar = document.getElementById('sonar-visualizer');
                sonar.innerHTML = ''; // Clear old bubbles
                const table = document.getElementById('whale-table');
                table.innerHTML = '';

                // Take Top 8 for Bubbles (to keep it clean)
                whales.whales.slice(0, 8).forEach((w, i) => {
                    // Create Bubble
                    const size = Math.max(30, Math.min(100, w.balance / 5000000)); // Scale bubble
                    const bubble = document.createElement('div');
                    bubble.className = 'whale-bubble';
                    bubble.style.width = `${size}px`;
                    bubble.style.height = `${size}px`;
                    bubble.style.animationDelay = `${i * 0.2}s`;
                    bubble.title = `${w.name}: ${formatNumber(w.balance, false)} KAS`;
                    bubble.innerHTML = `<span class="bubble-rank">#${w.rank}</span>`;
                    sonar.appendChild(bubble);

                    // Add to mini list (Top 5)
                    if (i < 5) {
                        const row = `<tr>
                            <td style="color:#00CCCC">#${w.rank}</td>
                            <td>${w.name !== 'Unknown Whale' ? w.name : w.address.substring(0,8)+'...'}</td>
                            <td style="text-align:right">${formatNumber(w.balance, false)}</td>
                        </tr>`;
                        table.innerHTML += row;
                    }
                });
            }
        };

        window.onload = () => {
            updateDashboard();
            setInterval(updateDashboard, 60000); // 1 min refresh
        };
    </script>
</body>
</html>
